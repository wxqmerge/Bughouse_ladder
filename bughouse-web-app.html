!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bughouse Chess Ladder</title>
    <meta name="version" content="1.2.1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            margin: 0;
        }

        .navbar {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            margin-bottom: 20px;
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .container-fluid {
            max-width: 2800px;
            margin: 0 auto;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-body {
            padding: 0;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.85rem;
        }

        .data-table th {
            background-color: #2563eb;
            color: white;
            font-weight: bold;
            padding: 15px 10px;
            white-space: nowrap;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .data-table td {
            border: 1px solid #e2e8f0;
            padding: 10px 8px;
            text-align: center;
            vertical-align: middle;
            background-color: white;
            min-width: 55px;
            max-width: 65px;
        }

        .data-table tr:hover td {
            background-color: #eff6ff;
        }

        .data-table td:first-child {
            background-color: rgba(255,255,255,0.95);
            font-weight: bold;
            border-left: 2px solid #2563eb;
            border-right: 1px solid #e2e8f0;
        }

        .badge-rank {
            background-color: #f59e0b;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            display: inline-block;
        }

        .btn-export {
            padding: 8px 16px;
            font-size: 0.85rem;
            margin-left: 5px;
        }

        .round-header {
            font-size: 0.85rem;
            color: #64748b;
        }

        .table-responsive {
            overflow-x: auto;
            max-height: 600px;
        }

        .table-responsive::-webkit-scrollbar {
            height: 10px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" style="display: flex; align-items: center; gap: 10px;">
                <i class="bi bi-chess-king"></i> Bughouse Chess Ladder
            </a>
            <small class="text-white-50" style="margin-right: 20px;">v1.2.1</small>
            <div style="display: flex;">
                <div class="search-box me-3">
                    <i class="bi bi-search text-primary"></i>
                    <input type="text" id="searchInput" placeholder="Search players..." style="font-size: 14px;">
                </div>
                <div>
                    <input type="file" id="fileUpload" accept=".xls,.xlsx,.txt" style="display: none;" onchange="handleFileUpload(event)">
                    <button class="btn btn-sm btn-outline-secondary btn-export" onclick="document.getElementById('fileUpload').click()">
                        <i class="bi bi-upload"></i> Import
                    </button>
                    <button class="btn btn-sm btn-success btn-export" onclick="exportToExcel()">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="data-table" id="ladderTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 90px;">Group</th>
                                <th style="width: 90px;">Last</th>
                                <th style="width: 100px;">First</th>
                                <th style="width: 80px;">Rate</th>
                                <th style="width: 60px;">Rnk</th>
                                <th style="width: 80px;">New</th>
                                <th style="width: 60px;">G</th>
                                <th style="width: 55px;" class="round-header">1</th>
                                <th style="width: 55px;" class="round-header">2</th>
                                <th style="width: 55px;" class="round-header">3</th>
                                <th style="width: 55px;" class="round-header">4</th>
                                <th style="width: 55px;" class="round-header">5</th>
                                <th style="width: 55px;" class="round-header">6</th>
                                <th style="width: 55px;" class="round-header">7</th>
                                <th style="width: 55px;" class="round-header">8</th>
                                <th style="width: 55px;" class="round-header">9</th>
                                <th style="width: 55px;" class="round-header">10</th>
                                <th style="width: 55px;" class="round-header">11</th>
                                <th style="width: 55px;" class="round-header">12</th>
                                <th style="width: 55px;" class="round-header">13</th>
                                <th style="width: 55px;" class="round-header">14</th>
                                <th style="width: 55px;" class="round-header">15</th>
                                <th style="width: 55px;" class="round-header">16</th>
                                <th style="width: 55px;" class="round-header">17</th>
                                <th style="width: 55px;" class="round-header">18</th>
                                <th style="width: 55px;" class="round-header">19</th>
                                <th style="width: 55px;" class="round-header">20</th>
                                <th style="width: 55px;" class="round-header">21</th>
                                <th style="width: 55px;" class="round-header">22</th>
                                <th style="width: 55px;" class="round-header">23</th>
                                <th style="width: 55px;" class="round-header">24</th>
                                <th style="width: 55px;" class="round-header">25</th>
                                <th style="width: 55px;" class="round-header">26</th>
                                <th style="width: 55px;" class="round-header">27</th>
                                <th style="width: 55px;" class="round-header">28</th>
                                <th style="width: 55px;" class="round-header">29</th>
                                <th style="width: 55px;" class="round-header">30</th>
                                <th style="width: 55px;" class="round-header">31</th>
                            </tr>
                        </thead>
                        <tbody id="ladderTableBody">
                            <tr>
                                <td colspan="43" class="text-center py-5">
                                    <p class="text-muted">No data loaded yet. Please import an Excel file.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <script>
        let players = [];
        let globalKFactor = 32;

        document.addEventListener('DOMContentLoaded', function() {
            loadGameData();
        });

        function loadGameData() {
            const fileInput = document.getElementById('fileUpload');
            if (fileInput) {
                fileInput.removeAttribute('required');
            }
            const savedData = localStorage.getItem('bughouse_players');
            if (savedData) {
                try {
                    players = JSON.parse(savedData);
                    renderLadder();
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            } else {
                loadPlayersTxt();
            }
        }

        function loadPlayersTxt() {
            fetch('players.txt')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('players.txt not found');
                    }
                    return response.text();
                })
                .then(text => {
                    console.log('Loading players.txt...');
                    const lines = text.split(/\r?\n/);
                    const jsonData = lines.map(line => {
                        if (line.trim() === '') return [];
                        return line.split('\t').map(cell => cell.trim());
                    }).filter(row => row.length > 0 || row[0]?.trim() !== '');

                    if (jsonData && jsonData.length > 0) {
                        processExcelData(jsonData);
                    } else {
                        console.log('No data found in players.txt');
                    }
                })
                .catch(error => {
                    console.log('No players.txt file found, starting with empty data:', error);
                });
        }

        function saveGameData() {
            localStorage.setItem('bughouse_players', JSON.stringify(players));
        }

        function handleFileUploadButton() {
            document.getElementById('fileUpload').click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            try {
                if (file.name.toLowerCase().endsWith('.xls') || file.name.toLowerCase().endsWith('.xlsx')) {
                    reader.onload = function(e) {
                        try {
                            const data = e.target.result;
                            const workbook = XLSX.read(data, {type: 'binary'});
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                                header: 1,
                                blankrows: false
                            });

                            if (jsonData && jsonData.length > 0) {
                                processExcelData(jsonData);
                            } else {
                                showToast('No valid data found in Excel file', 'danger');
                            }
                        } catch (error) {
                            console.error('Error parsing Excel file:', error);
                            showToast('Error parsing Excel file', 'danger');
                        }
                    };
                    reader.readAsBinaryString(file);
                } else {
                    reader.onload = function(e) {
                        try {
                            const text = e.target.result;
                            const lines = text.split(/\r?\n/);
                            const jsonData = lines.map(line => {
                                if (line.trim() === '') return [];
                                return line.split('\t').map(cell => cell.trim());
                            }).filter(row => row.length > 0 || row[0]?.trim() !== '');

                            if (jsonData && jsonData.length > 0) {
                                processExcelData(jsonData);
                            } else {
                                showToast('No valid data found in file', 'danger');
                            }
                        } catch (error) {
                            showToast('Error parsing file', 'danger');
                        }
                    };
                    reader.readAsText(file);
                }
            } catch (error) {
                showToast('Error reading file', 'danger');
            }

            event.target.value = '';
        }

        function processExcelData(jsonData, append = false) {
            // Check if row 0 is a header row containing 'Group' regardless of case
            const firstRow = jsonData[0];

            // More robust header detection
            const firstCell = String(firstRow?.[0] || '').trim();
            const headerString = firstCell.toLowerCase();
            const isHeader = headerString === 'group' || headerString.includes('group');

            const startIndex = isHeader ? 1 : 0;

            if (!append) {
                players = [];
            }

            for (let i = startIndex; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0 || (row.length > 0 && !row[0] && !row[1])) {
                    continue;
                }

                const player = {
                    id: 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    group: row[0] || '',
                    lastName: row[1] || '',
                    firstName: row[2] || '',
                    rating: parseInt(row[3]) || 1000,
                    ranking: parseInt(row[4]) || i + 1,
                    newRating: parseInt(row[5]) || parseInt(row[3]) || 1000,
                    games: parseInt(row[6]) || 0,
                    grade: row[8] || '',
                    phone: row[9] || '',
                    info: row[10] || '',
                    school: row[11] || '',
                    room: row[12] || ''
                };

                players.push(player);
            }

            saveGameData();
            renderLadder();
            showToast(`Imported ${players.length} players from file`, 'success');
        }

        function renderLadder() {
            const tbody = document.getElementById('ladderTableBody');

            if (players.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="43" class="text-center py-5">
                            <p class="text-muted">No data loaded yet. Please import an Excel file.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedPlayers = [...players].sort((a, b) => {
                if ((a.ranking || 0) !== (b.ranking || 0)) {
                    return (b.ranking || 0) - (a.ranking || 0);
                }
                return (b.rating || 0) - (a.rating || 0);
            });

            tbody.innerHTML = sortedPlayers.map((player, playerIndex) => `
                <tr>
                    <td>${playerIndex + 1}</td>
                    <td>${(player.group || '').trim()}</td>
                    <td>${(player.lastName || '').trim()}</td>
                    <td>${(player.firstName || '').trim()}</td>
                    <td><span class="badge-rank" style="font-size: 0.8rem; padding: 4px 8px;">${player.rating}</span></td>
                    <td>${player.ranking}</td>
                    <td>${player.newRating}</td>
                    <td>${player.games}</td>
                    <td>${player.round1 || ''}</td>
                    <td>${player.round2 || ''}</td>
                    <td>${player.round3 || ''}</td>
                    <td>${player.round4 || ''}</td>
                    <td>${player.round5 || ''}</td>
                    <td>${player.round6 || ''}</td>
                    <td>${player.round7 || ''}</td>
                    <td>${player.round8 || ''}</td>
                    <td>${player.round9 || ''}</td>
                    <td>${player.round10 || ''}</td>
                    <td>${player.round11 || ''}</td>
                    <td>${player.round12 || ''}</td>
                    <td>${player.round13 || ''}</td>
                    <td>${player.round14 || ''}</td>
                    <td>${player.round15 || ''}</td>
                    <td>${player.round16 || ''}</td>
                    <td>${player.round17 || ''}</td>
                    <td>${player.round18 || ''}</td>
                    <td>${player.round19 || ''}</td>
                    <td>${player.round20 || ''}</td>
                    <td>${player.round21 || ''}</td>
                    <td>${player.round22 || ''}</td>
                    <td>${player.round23 || ''}</td>
                    <td>${player.round24 || ''}</td>
                    <td>${player.round25 || ''}</td>
                    <td>${player.round26 || ''}</td>
                    <td>${player.round27 || ''}</td>
                    <td>${player.round28 || ''}</td>
                    <td>${player.round29 || ''}</td>
                    <td>${player.round30 || ''}</td>
                    <td>${player.round31 || ''}</td>
                </tr>
            `).join('');
        }

        function exportToExcel() {
            if (players.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }

            const headerRow = [
                'Group', 'Last Name', 'First Name', 'Rating', 'Rank', 'New Rating', 'Games', 'Grade', 'Phone', 'Info', 'School', 'Room'
            ];

            const roundHeaders = [];
            for (let i = 1; i <= 31; i++) {
                roundHeaders.push(`Round ${i}`);
            }

            const allHeaders = [...headerRow, ...roundHeaders];

            const dataRows = players.map(p => [
                p.group,
                p.lastName,
                p.firstName,
                p.rating,
                p.ranking,
                p.newRating,
                p.games,
                p.grade,
                p.phone,
                p.info,
                p.school,
                p.room
            ]);

            const lines = [allHeaders.join('\t'), ...dataRows.map(row => row.join('\t'))];

            const blob = new Blob(lines.join('\n') + '\n', { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Bughouse_Ladder_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();

            showToast('Tab-delimited file exported successfully', 'success');
        }

        function searchPlayers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm) {
                renderLadder();
                return;
            }

            const filteredPlayers = players.filter(p => 
                (p.firstName || '').toLowerCase().includes(searchTerm) || 
                (p.lastName || '').toLowerCase().includes(searchTerm) ||
                (p.school || '').toLowerCase().includes(searchTerm)
            );

            const tbody = document.getElementById('ladderTableBody');

            const sortedPlayers = [...filteredPlayers].sort((a, b) => {
                if ((a.ranking || 0) !== (b.ranking || 0)) {
                    return (b.ranking || 0) - (a.ranking || 0);
                }
                return (b.rating || 0) - (a.rating || 0);
            });

            tbody.innerHTML = sortedPlayers.map((player, playerIndex) => `
                <tr>
                    <td>${playerIndex + 1}</td>
                    <td>${(player.group || '').trim()}</td>
                    <td>${(player.lastName || '').trim()}</td>
                    <td>${(player.firstName || '').trim()}</td>
                    <td><span class="badge-rank" style="font-size: 0.8rem; padding: 4px 8px;">${player.rating}</span></td>
                    <td>${player.ranking}</td>
                    <td>${player.newRating}</td>
                    <td>${player.games}</td>
                    <td>${player.round1 || ''}</td>
                    <td>${player.round2 || ''}</td>
                    <td>${player.round3 || ''}</td>
                    <td>${player.round4 || ''}</td>
                    <td>${player.round5 || ''}</td>
                    <td>${player.round6 || ''}</td>
                    <td>${player.round7 || ''}</td>
                    <td>${player.round8 || ''}</td>
                    <td>${player.round9 || ''}</td>
                    <td>${player.round10 || ''}</td>
                    <td>${player.round11 || ''}</td>
                    <td>${player.round12 || ''}</td>
                    ${player.round13 || ''}</td>
                    ${player.round14 || ''}</td>
                    ${player.round15 || ''}</td>
                    ${player.round16 || ''}</td>
                    ${player.round17 || ''}</td>
                    ${player.round18 || ''}</td>
                    ${player.round19 || ''}</td>
                    ${player.round20 || ''}</td>
                    ${player.round21 || ''}</td>
                    ${player.round22 || ''}</td>
                    ${player.round23 || ''}</td>
                    ${player.round24 || ''}</td>
                    ${player.round25 || ''}</td>
                    ${player.round26 || ''}</td>
                    ${player.round27 || ''}</td>
                    ${player.round28 || ''}</td>
                    ${player.round29 || ''}</td>
                    ${player.round30 || ''}</td>
                    ${player.round31 || ''}</td>
                </tr>
            `).join('');
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastElement = document.createElement('div');
            toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
            toastElement.setAttribute('role', 'alert');
            toastElement.setAttribute('aria-live', 'assertive');
            toastElement.setAttribute('aria-atomic', 'true');
            toastElement.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            toastContainer.appendChild(toastElement);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>