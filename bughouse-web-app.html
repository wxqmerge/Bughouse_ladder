!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bughouse Chess Ladder</title>
    <meta name="version" content="1.3.2">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            margin: 0;
        }

        .navbar {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            margin-bottom: 20px;
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .container-fluid {
            max-width: 2800px;
            margin: 0 auto;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.8rem;
        }

        .data-table th {
            background-color: #2563eb;
            color: white;
            font-weight: bold;
            padding: 12px 8px;
            white-space: nowrap;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .data-table td {
            border: 1px solid #e2e8f0;
            padding: 6px 4px;
            text-align: center;
            vertical-align: middle;
            background-color: white;
            min-width: 50px;
            max-width: 65px;
        }

        .data-table tr:hover td {
            background-color: #eff6ff;
        }

        .data-table td:first-child {
            background-color: rgba(255,255,255,0.95);
            font-weight: bold;
            border-left: 2px solid #2563eb;
            border-right: 1px solid #e2e8f0;
        }

        .badge-rank {
            background-color: #f59e0b;
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        .btn-export {
            padding: 6px 14px;
            font-size: 0.8rem;
        }

        .round-header {
            font-size: 0.8rem;
            color: #64748b;
        }

        .table-responsive {
            overflow-x: auto;
            max-height: 600px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" style="display: flex; align-items: center; gap: 10px;">
                <i class="bi bi-chess-king"></i> Bughouse Chess Ladder
            </a>
            <small class="text-white-50" style="margin-right: 20px;">v1.3.2</small>
            <div style="display: flex;">
                <div class="me-3">
                    <input type="file" id="fileUpload" accept=".xls,.xlsx,.txt" style="display: none;" onchange="handleFileUpload(event)">
                    <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('fileUpload').click()">
                        <i class="bi bi-upload"></i> Import
                    </button>
                    <button class="btn btn-sm btn-success" onclick="exportToExcel()">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="data-table" id="ladderTable">
                        <thead>
                            <tr>
                                <th style="width: 40px; background-color: #1e40af;">#</th>
                                <th style="width: 80px;">Group</th>
                                <th style="width: 80px;">Last</th>
                                <th style="width: 90px;">First</th>
                                <th style="width: 75px;">Rate</th>
                                <th style="width: 50px;">Rnk</th>
                                <th style="width: 75px;">New</th>
                                <th style="width: 50px;">G</th>
                                <th style="width: 50px;" class="round-header">1</th>
                                <th style="width: 50px;" class="round-header">2</th>
                                <th style="width: 50px;" class="round-header">3</th>
                                <th style="width: 50px;" class="round-header">4</th>
                                <th style="width: 50px;" class="round-header">5</th>
                                <th style="width: 50px;" class="round-header">6</th>
                                <th style="width: 50px;" class="round-header">7</th>
                                <th style="width: 50px;" class="round-header">8</th>
                                <th style="width: 50px;" class="round-header">9</th>
                                <th style="width: 50px;" class="round-header">10</th>
                                <th style="width: 50px;" class="round-header">11</th>
                                <th style="width: 50px;" class="round-header">12</th>
                                <th style="width: 50px;" class="round-header">13</th>
                                <th style="width: 50px;" class="round-header">14</th>
                                <th style="width: 50px;" class="round-header">15</th>
                                <th style="width: 50px;" class="round-header">16</th>
                                <th style="width: 50px;" class="round-header">17</th>
                                <th style="width: 50px;" class="round-header">18</th>
                                <th style="width: 50px;" class="round-header">19</th>
                                <th style="width: 50px;" class="round-header">20</th>
                                <th style="width: 50px;" class="round-header">21</th>
                                <th style="width: 50px;" class="round-header">22</th>
                                <th style="width: 50px;" class="round-header">23</th>
                                <th style="width: 50px;" class="round-header">24</th>
                                <th style="width: 50px;" class="round-header">25</th>
                                <th style="width: 50px;" class="round-header">26</th>
                                <th style="width: 50px;" class="round-header">27</th>
                                <th style="width: 50px;" class="round-header">28</th>
                                <th style="width: 50px;" class="round-header">29</th>
                                <th style="width: 50px;" class="round-header">30</th>
                                <th style="width: 50px;" class="round-header">31</th>
                            </tr>
                        </thead>
                        <tbody id="ladderTableBody">
                            <tr>
                                <td colspan="43" class="text-center py-5">
                                    <p class="text-muted">No data loaded yet. Please import an Excel file.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <script>
        let players = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadGameData();
        });

        function loadGameData() {
            const savedData = localStorage.getItem('bughouse_players');
            if (savedData) {
                try {
                    players = JSON.parse(savedData);
                    renderLadder();
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            } else {
                loadPlayersTxt();
            }
        }

        function loadPlayersTxt() {
            fetch('players.txt')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('players.txt not found');
                    }
                    return response.text();
                })
                .then(text => {
                    const lines = text.split(/\r?\n/);
                    const jsonData = lines.map(line => {
                        if (line.trim() === '') return [];
                        return line.split('\t').map(cell => cell.trim());
                    }).filter(row => row.length > 0);

                    if (jsonData.length > 0) {
                        processExcelData(jsonData);
                    }
                })
                .catch(error => {
                    console.clear();
                    console.log('No players.txt file found');
                });
        }

        function saveGameData() {
            localStorage.setItem('bughouse_players', JSON.stringify(players));
        }

        function handleFileUploadButton() {
            document.getElementById('fileUpload').click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            if (file.name.toLowerCase().endsWith('.xls') || file.name.toLowerCase().endsWith('.xlsx')) {
                reader.onload = function(e) {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, {type: 'binary'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                        header: 1,
                        blankrows: false
                    });

                    if (jsonData.length > 0) {
                        processExcelData(jsonData);
                    } else {
                        clearConsole();
                        showToast('No valid data found', 'danger');
                    }
                };
                reader.readAsBinaryString(file);
            } else {
                reader.onload = function(e) {
                    const text = e.target.result;
                    const lines = text.split(/\r?\n/);
                    const jsonData = lines.map(line => {
                        if (line.trim() === '') return [];
                        return line.split('\t').map(cell => cell.trim());
                    }).filter(row => row.length > 0);

                    if (jsonData.length > 0) {
                        processExcelData(jsonData);
                    } else {
                        clearConsole();
                        showToast('No valid data found', 'danger');
                    }
                };
                reader.readAsText(file);
            }

            event.target.value = '';
        }

        function clearConsole() {
            console.clear();
        }

        function processExcelData(jsonData) {
            const firstCell = String(jsonData[0]?.[0] || '').toLowerCase().trim();
            const isHeader = firstCell === 'group' || firstCell.includes('group');

            players = []);

            for (let i = (isHeader ? 1 : 0); i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;

                const group = row[0] || '';
                const lastName = row[1] || '';
                const firstName = row[2] || '';
                const rating = parseInt(row[3]) || 1000;
                const ranking = parseInt(row[4]) || i + 1;
                const newRating = parseInt(row[5]) || rating;
                const games = parseInt(row[6]) || 0;

                const player = {
                    group: group,
                    lastName: lastName,
                    firstName: firstName,
                    rating: rating,
                    ranking: ranking,
                    newRating: newRating,
                    games: games,
                    round1: row[14] || '',
                    round2: row[15] || '',
                    round3: row[16] || '',
                    round4: row[17] || '',
                    round5: row[18] || '',
                    round6: row[19] || '',
                    round7: row[20] || '',
                    round8: row[21] || '',
                    round9: row[22] || '',
                    round10: row[23] || '',
                    round11: row[24] || '',
                    round12: row[25] || '',
                    round13: row[26] || '',
                    round14: row[27] || '',
                    round15: row[28] || '',
                    round16: row[29] || '',
                    round17: row[30] || '',
                    round18: row[31] || '',
                    round19: row[32] || '',
                    round20: row[33] || '',
                    round21: row[34] || '',
                    round22: row[35] || '',
                    round23: row[36] || '',
                    round24: row[37] || '',
                    round25: row[38] || '',
                    round26: row[39] || '',
                    round27: row[40] || '',
                    round28: row[41] || '',
                    round29: row[42] || '',
                    round30: row[43] || '',
                    round31: row[44] || ''
                };

                players.push(player);
            }

            saveGameData();
            renderLadder();
            showToast(`Imported ${players.length} players`, 'success');
        }

        function renderLadder() {
            const tbody = document.getElementById('ladderTableBody');

            if (players.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="43" class="text-center py-5">
                            <p class="text-muted">No data loaded yet. Please import an Excel file.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedPlayers = [...players].sort((a, b) => {
                if ((a.ranking || 0) !== (b.ranking || 0)) {
                    return (b.ranking || 0) - (a.ranking || 0);
                }
                return (b.rating || 0) - (a.rating || 0);
            });

            tbody.innerHTML = sortedPlayers.map((player, playerIndex) => `
                <tr>
                    <td>${playerIndex + 1}</td>
                    <td>${(player.group || '').trim()}</td>
                    <td>${(player.lastName || '').trim()}</td>
                    <td>${(player.firstName || '').trim()}</td>
                    <td>
                        <span style="background-color: #f59e0b; color: white; padding: 4px 8px; border-radius: 10px; font-weight: bold;">
                            ${player.rating || 1000}
                        </span>
                    </td>
                    <td>${player.ranking || '-'}</td>
                    <td>${player.newRating || '-'}</td>
                    <td>${player.games || '-'}</td>
                    <td>${player.round1 || '-'}</td>
                    <td>${player.round2 || '-'}</td>
                    <td>${player.round3 || '-'}</td>
                    <td>${player.round4 || '-'}</td>
                    <td>${player.round5 || '-'}</td>
                    <td>${player.round6 || '-'}</td>
                    <td>${player.round7 || '-'}</td>
                    <td>${player.round8 || '-'}</td>
                    <td>${player.round9 || '-'}</td>
                    <td>${player.round10 || '-'}</td>
                    <td>${player.round11 || '-'}</td>
                    <td>${player.round12 || '-'}</td>
                    <td>${player.round13 || '-'}</td>
                    <td>${player.round14 || '-'}</td>
                    <td>${player.round15 || '-'}</td>
                    <td>${player.round16 || '-'}</td>
                    <td>${player.round17 || '-'}</td>
                    <td>${player.round18 || '-'}</td>
                    <td>${player.round19 || '-'}</td>
                    <td>${player.round20 || '-'}</td>
                    <td>${player.round21 || '-'}</td>
                    <td>${player.round22 || '-'}</td>
                    <td>${player.round23 || '-'}</td>
                    <td>${player.round24 || '-'}</td>
                    <td>${player.round25 || '-'}</td>
                    <td>${player.round26 || '-'}</td>
                    <td>${player.round27 || '-'}</td>
                    <td>${player.round28 || '-'}</td>
                    <td>${player.round29 || '-'}</td>
                    <td>${player.round30 || '-'}</td>
                    <td>${player.round31 || '-'}</td>
                </tr>
            `).join('');
        }

        function exportToExcel() {
            if (players.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }

            const baseHeaders = [
                'Group', 'Last Name', 'First Name', 'Rating', 'Rank', 'New Rating', 'Games'
            ];

            const roundHeaders = [];
            for (let i = 1; i <= 31; i++) {
                roundHeaders.push(`Round ${i}`);
            }

            const allHeaders = [...baseHeaders, ...roundHeaders];

            const dataRows = players.map(p => [
                p.group,
                p.lastName,
                p.firstName,
                p.rating,
                p.ranking,
                p.newRating,
                p.games,
                p.round1,
                p.round2,
                p.round3,
                p.round4,
                p.round5,
                p.round6,
                p.round7,
                p.round8,
                p.round9,
                p.round10,
                p.round11,
                p.round12,
                p.round13,
                p.round14,
                p.round15,
                p.round16,
                p.round17,
                p.round18,
                p.round19,
                p.round20,
                p.round21,
                p.round22,
                p.round23,
                p.round24,
                p.round25,
                p.round26,
                p.round27,
                p.round28,
                p.round29,
                p.round30,
                p.round31
            ]);

            const lines = [allHeaders.join('\t'), ...dataRows.map(row => row.join('\t'))];

            const blob = new Blob(lines.join('\n') + '\n', { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Bughouse_Ladder_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();

            showToast('Export successful', 'success');
        }

        function searchPlayers() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            if (!term) {
                renderLadder();
                return;
            }

            const sortedPlayers = [...players].sort((a, b) => {
                if ((a.ranking || 0) !== (b.ranking || 0)) {
                    return (b.ranking || 0) - (a.ranking || 0);
                }
                return (b.rating || 0) - (a.rating || 0);
            });

            const tbody = document.getElementById('ladderTableBody');

            tbody.innerHTML = sortedPlayers.map((player, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${(player.group || '').trim()}</td>
                    <td>${(player.lastName || '').trim()}</td>
                    <td>${(player.firstName || '').trim()}</td>
                    <td>${player.rating || 1000}</td>
                    <td>${player.ranking || '-'}</td>
                    <td>${player.newRating || '-'}</td>
                    <td>${player.games || '-'}</td>
                    <td>${player.round1 || '-'}</td>
                    <td>${player.round2 || '-'}</td>
                    <td>${player.round3 || '-'}</td>
                    <td>${player.round4 || '-'}</td>
                    <td>${player.round5 || '-'}</td>
                    <td>${player.round6 || '-'}</td>
                    <td>${player.round7 || '-'}</td>
                    <td>${player.round8 || '-'}</td>
                    <td>${player.round9 || '-'}</td>
                    <td>${player.round10 || '-'}</td>
                    <td>${player.round11 || '-'}</td>
                    <td>${player.round12 || '-'}</td>
                    <td>${player.round13 || '-'}</td>
                    <td>${player.round14 || '-'}</td>
                    <td>${player.round15 || '-'}</td>
                    <td>${player.round16 || '-'}</td>
                    <td>${player.round17 || '-'}</td>
                    <td>${player.round18 || '-'}</td>
                    <td>${player.round19 || '-'}</td>
                    <td>${player.round20 || '-'}</td>
                    <td>${player.round21 || '-'}</td>
                    <td>${player.round22 || '-'}</td>
                    <td>${player.round23 || '-'}</td>
                    <td>${player.round24 || '-'}</td>
                    <td>${player.round25 || '-'}</td>
                    <td>${player.round26 || '-'}</td>
                    <td>${player.round27 || '-'}</td>
                    <td>${player.round28 || '-'}</td>
                    <td>${player.round29 || '-'}</td>
                    <td>${player.round30 || '-'}</td>
                    <td>${player.round31 || '-'}</td>
                </tr>
            `).join('');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0 mb-2`;
            toast.style.minWidth = '250px';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            container.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 2000 });
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', function() {
                toast.remove();
            });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>